<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Computer Vision</title>
    <style>
        /* === Stili Globali === */
        html {
            box-sizing: border-box;
            overflow-x: hidden;
        }
        *, *::before, *::after {
            box-sizing: inherit;
        }
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #f0fff0;
            font-family: Helvetica, sans-serif;
            padding-top: 70px;
        }

        /* === Header === */
        .site-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #000;
            z-index: 1000;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .site-header.with-border {
            border-bottom: 1px solid #fff;
        }
        .site-header h1 {
            font-size: 1.8em;
            font-weight: bold;
            color: #7cfc00;
            margin: 0;
            display: none;
        }
        #change-image-controls {
            display: none;
        }
        #change-image-button {
            color: #fff;
            font-size: 0.9em;
            cursor: pointer;
            text-transform: uppercase;
            font-weight: bold;
            padding: 8px 12px;
            background-color: transparent;
            border: 1px solid #fff;
            border-radius: 4px;
        }
        #change-image-button:hover {
            background-color: #333;
        }

        #initial-upload-prompt {
            font-size: 2.5em;
            font-weight: bold;
            color: #7cfc00;
            text-align: center;
            cursor: pointer;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 900;
        }

        .hidden-file-input {
            display: none;
        }

        #main-content-wrapper {
            display: none;
        }

        .content-block {
            max-width: 960px;
            margin-left: 20px;
            margin-right: 20px;
            padding-top: 20px;
            padding-bottom: 0;
            padding-left: 0;
            padding-right: 20px;
        }
        #uploaded-image-section {}
        .technique-entry {
            padding-bottom: 20px;
        }
        .content-block h2 {
            font-size: 1.8em;
            color: #7cfc00;
            font-weight: bold;
            margin-top: 0;
            margin-bottom: 15px;
        }
        .content-block p {
            margin-bottom: 15px;
        }
        #uploaded-image-display, .modified-image-display {
            max-width: 100%;
            height: auto;
            display: block;
            margin-bottom: 8pt;
        }
        .image-sub-text {
            font-size: 8pt;
            color: #a9a9a9;
            text-align: left;
            margin-bottom: 15px; /* Questo margine influenzerà l'allineamento con flex-end */
        }

        /* === Stili per la Dimostrazione Sobel === */
        .sobel-demonstration .image-comparison-container {
            display: flex;
            /* gap: 10px; /* Spazio tra gli elementi ridotto ulteriormente */
            margin-bottom: 15px;
            align-items: flex-end; /* Allinea gli elementi flex (immagini e controlli slider) alla loro base */
        }
        .sobel-demonstration .image-container {
            flex: 1;
            min-width: 0;
            margin-right: 10px; /* Spazio tra contenitori immagine e controlli slider */
        }
        .sobel-demonstration .image-container:last-of-type { /* Rimuove margine destro per l'ultimo contenitore immagine prima dello slider */
             margin-right: 0;
        }

        .sobel-demonstration canvas {
            max-width: 100%;
            height: auto;
            display: block;
            border: 1px solid #444;
            margin-bottom: 8pt;
        }
        
        .sobel-controls-vertical {
            display: flex;
            flex-direction: column; /* Slider sopra, etichetta sotto */
            align-items: center;
            margin-left: 10px;    /* Avvicina lo slider all'immagine Sobel */
            width: auto; /* Lascia che la larghezza sia definita dal contenuto (slider e etichetta) */
            min-width: 40px; /* Per assicurare un po' di spazio per l'etichetta */
            /* La parte inferiore di questo blocco si allineerà con la parte inferiore
               dei p.image-sub-text grazie a align-items: flex-end sul genitore */
        }
        .sobel-controls-vertical label {
            font-size: 0.9em;
            font-weight: bold; /* Richiesto */
            color: #fff;       /* Richiesto */
            white-space: nowrap;
            /* margin-top: 8px; Spazio dallo slider sopra, gestito da margin-bottom dello slider */
        }

        #sobel-threshold-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 150px;  /* LUNGHEZZA dello slider verticale */
            height: 22px;  /* LARGHEZZA/spessore dell'area cliccabile (include spazio per thumb) */
            background: transparent;
            cursor: pointer;
            margin: 0;
            transform-origin: center center;
            transform: rotate(-90deg);
            margin-bottom: 25px; /* Spazio tra slider ruotato (ora la sua "base" è a destra) e l'etichetta sotto */
                                /* Questo valore potrebbe necessitare di aggiustamenti per l'allineamento visivo */
        }

        #sobel-threshold-slider::-webkit-slider-runnable-track {
            width: 100%; /* Lunghezza della track (150px) */
            height: 8px; /* Spessore della track */
            background: #fff;
            border-radius: 4px;
            border: none; /* Rimosso bordo */
        }
        #sobel-threshold-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #7cfc00;
            border-radius: 0; /* Quadrato */
            border: none; /* Rimosso bordo */
            margin-top: -6px; /* (8px track / 2) - (20px thumb / 2) = 4px - 10px = -6px */
        }

        #sobel-threshold-slider::-moz-range-track {
            width: 100%;
            height: 8px;
            background: #fff;
            border-radius: 4px;
            border: none; /* Rimosso bordo */
        }
        #sobel-threshold-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #7cfc00;
            border-radius: 0; /* Quadrato */
            border: none; /* Rimosso bordo */
        }

        .full-bleed-separator {
            width: 100%;
            height: 1px;
            background-color: #fff;
            margin-top: 40px;
            margin-bottom: 40px;
        }

        #credits-info {
            position: fixed;
            bottom: 20px;
            right: 20px;
            color: #fff;
            font-size: 0.9em;
            font-weight: bold;
            text-align: right;
            line-height: 1.3;
            z-index: 1000;
            display: none;
        }
    </style>
</head>
<body>

    <header class="site-header">
        <h1>Computer Vision</h1>
        <div id="change-image-controls">
            <button id="change-image-button">CAMBIA IMMAGINE</button>
            <input type="file" id="secondary-file-input" class="hidden-file-input" accept="image/*">
        </div>
    </header>

    <div id="initial-upload-prompt">Upload image</div>
    <input type="file" id="primary-file-input" class="hidden-file-input" accept="image/*">

    <div id="main-content-wrapper">
        <div class="content-block" id="uploaded-image-section">
            <img id="uploaded-image-display" src="#" alt="Immagine caricata">
            <p class="image-sub-text">Immagine caricata dall'utente.</p>
        </div>

        <div class="full-bleed-separator"></div>

        <div class="content-block technique-entry">
            <h2>Primi Tentativi e Riconoscimento di Forme (Anni '60-'70)</h2>
            <p>I primi approcci alla computer vision si concentravano sul riconoscimento di forme geometriche semplici e sull'analisi di immagini binarie. Tecniche come l'estrazione dei bordi (ad esempio con l'algoritmo di Sobel) e la segmentazione basata su soglie erano fondamentali.</p>
            
            <div class="sobel-demonstration">
                <div class="image-comparison-container">
                    <div class="image-container" id="grayscale-image-wrapper">
                        <canvas id="grayscale-canvas"></canvas>
                        <p class="image-sub-text">Immagine in Scala di Grigi</p>
                    </div>
                    <div class="image-container" id="sobel-image-wrapper">
                        <canvas id="sobel-canvas"></canvas>
                        <p class="image-sub-text">Rilevamento Bordi (Sobel)</p>
                    </div>
                    <div class="sobel-controls-vertical">
                        <input type="range" id="sobel-threshold-slider" min="0" max="255" value="100"> <label for="sobel-threshold-slider">K: <span id="threshold-value-display">100</span></label>
                    </div>
                </div>
            </div>
        </div>

        <div class="full-bleed-separator"></div>

        <div class="content-block technique-entry">
            <h2>Visione 3D e Modellazione (Anni '80)</h2>
            <p>Negli anni '80, la ricerca si spostò verso la comprensione della geometria tridimensionale a partire da immagini 2D. Tecniche come la fotogrammetria e l'analisi del flusso ottico iniziarono a svilupparsi.</p>
            <img class="modified-image-display" src="placeholder_3d.png" alt="Ricostruzione 3D approssimata">
            <p class="image-sub-text">Esempio di ricostruzione 3D approssimata.</p>
        </div>

        <div class="full-bleed-separator"></div>

        <div class="content-block technique-entry">
            <h2>Riconoscimento di Oggetti e Machine Learning (Anni '90-'2000)</h2>
            <p>L'avvento del machine learning ha rivoluzionato la computer vision, portando a progressi significativi nel riconoscimento di oggetti, nell'analisi di scene e nel tracciamento video. Algoritmi come SVM e le prime reti neurali hanno giocato un ruolo cruciale.</p>
            <img class="modified-image-display" src="placeholder_oggetti.png" alt="Oggetti rilevati">
            <p class="image-sub-text">Esempio di immagine con oggetti rilevati.</p>
        </div>

        <div class="full-bleed-separator"></div>

        <div class="content-block technique-entry">
            <h2>Deep Learning e Intelligenza Artificiale (Anni 2010-oggi)</h2>
            <p>L'esplosione del deep learning, con architetture come le CNN (Convolutional Neural Networks), ha portato a prestazioni senza precedenti in molti compiti di computer vision, come il riconoscimento facciale, la guida autonoma e l'analisi medica.</p>
            <img class="modified-image-display" src="placeholder_deeplearning.png" alt="Analisi avanzata">
            <p class="image-sub-text">Esempio di analisi avanzata con deep learning.</p>
        </div>
    </div>

    <div id="credits-info">
        ISIA U<br>
        Elia Miodini<br>
        Aiudi Francesco
    </div>

    <script>
        // Elementi DOM
        const siteHeader = document.querySelector('.site-header');
        const headerTitle = siteHeader.querySelector('h1');
        const changeImageControls = document.getElementById('change-image-controls');
        const changeImageButton = document.getElementById('change-image-button');
        const secondaryFileInput = document.getElementById('secondary-file-input');

        const initialUploadPrompt = document.getElementById('initial-upload-prompt');
        const primaryFileInput = document.getElementById('primary-file-input');

        const mainContentWrapper = document.getElementById('main-content-wrapper');
        const uploadedImageDisplay = document.getElementById('uploaded-image-display');
        const modifiedImageDisplays = document.querySelectorAll('.modified-image-display');


        const creditsInfo = document.getElementById('credits-info');

        const placeholderImages = [ 
            'placeholder_3d.png',
            'placeholder_oggetti.png',
            'placeholder_deeplearning.png'
        ];

        const grayscaleCanvas = document.getElementById('grayscale-canvas');
        const sobelCanvas = document.getElementById('sobel-canvas');
        const sobelThresholdSlider = document.getElementById('sobel-threshold-slider');
        const thresholdValueDisplay = document.getElementById('threshold-value-display');

        let grayscaleImageData = null; 
        let gradientMagnitudeData = null; 


        function showInitialState() {
            headerTitle.style.display = 'none';
            siteHeader.classList.remove('with-border');
            changeImageControls.style.display = 'none';
            initialUploadPrompt.style.display = 'block';
            mainContentWrapper.style.display = 'none';
            creditsInfo.style.display = 'none';

            modifiedImageDisplays.forEach((img, index) => {
                if (placeholderImages[index]) {
                    img.src = placeholderImages[index];
                }
            });
            if (uploadedImageDisplay.getAttribute('src') !== '#') {
                 uploadedImageDisplay.src = '#';
            }
            const canvases = [grayscaleCanvas, sobelCanvas];
            canvases.forEach(canvas => {
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    const parentWidth = canvas.parentElement.offsetWidth > 20 ? canvas.parentElement.offsetWidth - 10 : 180; // Stima larghezza disponibile
                    const placeholderWidth = Math.max(50, parentWidth); // Evita larghezza 0 o negativa
                    const placeholderHeight = placeholderWidth * 0.75;
                    canvas.width = placeholderWidth; 
                    canvas.height = placeholderHeight;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#222'; 
                    ctx.fillRect(0,0,canvas.width, canvas.height);
                    ctx.fillStyle = '#555'; 
                    ctx.textAlign='center'; 
                    ctx.font = '12px Helvetica';
                    ctx.fillText('N/D', canvas.width/2, canvas.height/2); // N/D più corto
                }
            });
            if(thresholdValueDisplay) thresholdValueDisplay.textContent = sobelThresholdSlider.value;
        }

        function showContentState(imageSrc) {
            uploadedImageDisplay.src = imageSrc; 
            modifiedImageDisplays.forEach(img => img.src = imageSrc);

            headerTitle.style.display = 'block';
            siteHeader.classList.add('with-border');
            changeImageControls.style.display = 'flex';
            initialUploadPrompt.style.display = 'none';
            mainContentWrapper.style.display = 'block';
            creditsInfo.style.display = 'block';

            const tempImg = new Image();
            tempImg.onload = () => {
                processImageForSobel(tempImg); 
                applyThresholdAndDrawSobel(parseInt(sobelThresholdSlider.value));
            };
            tempImg.src = imageSrc;
        }

        function convertToGrayscale(sourceCanvas) {
            const ctx = sourceCanvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, sourceCanvas.width, sourceCanvas.height);
            const data = imageData.data;
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                const gray = 0.299 * r + 0.587 * g + 0.114 * b;
                data[i] = data[i + 1] = data[i + 2] = gray;
            }
            return imageData;
        }

        function applySobel(gsImageData) {
            const width = gsImageData.width;
            const height = gsImageData.height;
            const data = gsImageData.data;
            
            gradientMagnitudeData = new Float32Array(width * height);
            let maxGradient = 0;

            const Gx = [[-1, 0, 1],[-2, 0, 2],[-1, 0, 1]];
            const Gy = [[-1, -2, -1],[ 0,  0,  0],[ 1,  2,  1]];

            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    let sumGx = 0;
                    let sumGy = 0;
                    for (let ky = -1; ky <= 1; ky++) {
                        for (let kx = -1; kx <= 1; kx++) {
                            const pixel_idx = ((y + ky) * width + (x + kx)) * 4;
                            const gray_val = data[pixel_idx];
                            sumGx += gray_val * Gx[ky + 1][kx + 1];
                            sumGy += gray_val * Gy[ky + 1][kx + 1];
                        }
                    }
                    const magnitude = Math.sqrt(sumGx * sumGx + sumGy * sumGy);
                    gradientMagnitudeData[y * width + x] = magnitude;
                    if (magnitude > maxGradient) maxGradient = magnitude;
                }
            }
            
            if (maxGradient > 0) {
                for (let i = 0; i < gradientMagnitudeData.length; i++) {
                    gradientMagnitudeData[i] = (gradientMagnitudeData[i] / maxGradient) * 255;
                }
            }
        }

        function applyThresholdAndDrawSobel(threshold) {
            if (!gradientMagnitudeData || !sobelCanvas || !grayscaleCanvas) return;

            const width = grayscaleCanvas.width;
            const height = grayscaleCanvas.height;
            
            sobelCanvas.width = width;
            sobelCanvas.height = height;
            const ctxSobel = sobelCanvas.getContext('2d');
            const outputImageData = ctxSobel.createImageData(width, height);
            const outputData = outputImageData.data;

            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const i = y * width + x;
                    const magnitude = gradientMagnitudeData[i] || 0;
                    const edgeColor = magnitude > threshold ? 255 : 0;
                    const pixelIndex = i * 4;
                    outputData[pixelIndex] = edgeColor;
                    outputData[pixelIndex + 1] = edgeColor;
                    outputData[pixelIndex + 2] = edgeColor;
                    outputData[pixelIndex + 3] = 255;
                }
            }
            ctxSobel.putImageData(outputImageData, 0, 0);
        }

        function processImageForSobel(imageElement) {
            grayscaleCanvas.width = imageElement.naturalWidth;
            grayscaleCanvas.height = imageElement.naturalHeight;
            const ctxGrayscale = grayscaleCanvas.getContext('2d');
            ctxGrayscale.drawImage(imageElement, 0, 0, imageElement.naturalWidth, imageElement.naturalHeight);
            
            grayscaleImageData = convertToGrayscale(grayscaleCanvas);
            ctxGrayscale.putImageData(grayscaleImageData,0,0);

            applySobel(grayscaleImageData);
        }

        function handleFileLoad(file, triggerInput) {
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    showContentState(e.target.result);
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    if (triggerInput === primaryFileInput) {
                        secondaryFileInput.files = dataTransfer.files;
                    } else if (triggerInput === secondaryFileInput) {
                        primaryFileInput.files = dataTransfer.files;
                    }
                }
                reader.readAsDataURL(file);
            } else {
                if (uploadedImageDisplay.getAttribute('src') === '#' || !uploadedImageDisplay.getAttribute('src')) {
                    showInitialState();
                }
            }
        }
        
        if (sobelThresholdSlider) {
            sobelThresholdSlider.addEventListener('input', function() {
                if(thresholdValueDisplay) thresholdValueDisplay.textContent = this.value;
                applyThresholdAndDrawSobel(parseInt(this.value));
            });
        }

        initialUploadPrompt.addEventListener('click', () => { primaryFileInput.click(); });
        primaryFileInput.addEventListener('change', function() { handleFileLoad(this.files[0], this); });
        changeImageButton.addEventListener('click', () => { secondaryFileInput.click(); });
        secondaryFileInput.addEventListener('change', function() { handleFileLoad(this.files[0], this); });

        showInitialState();
    </script>
</body>
</html>